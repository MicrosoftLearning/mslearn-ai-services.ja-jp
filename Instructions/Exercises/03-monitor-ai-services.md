---
lab:
  title: Azure AI サービスを監視する
  module: Module 2 - Developing AI Apps with Azure AI Services
---

# Azure AI サービスを監視する

Azure AI サービスは、アプリケーション インフラストラクチャ全体の重要な部分になる可能性があります。 アクティビティを監視し、注意が必要な問題についてアラートを受け取ることができることが重要です。

## Visual Studio Code でリポジトリをクローンする

Visual Studio Code を使用してコードを開発します。 アプリのコード ファイルは、GitHub リポジトリで提供されています。

> **ヒント**: 既に **mslearn-ai-services** リポジトリをクローンしている場合は、Visual Studio Code で開きます。 それ以外の場合は、次の手順に従って開発環境に複製します。

1. Visual Studio Code を起動します。
2. パレットを開き (SHIFT+CTRL+P)、**Git:Clone** コマンドを実行して、`https://github.com/MicrosoftLearning/mslearn-ai-services` リポジトリをローカル フォルダーに複製します (どのフォルダーでも問題ありません)。
3. リポジトリを複製したら、Visual Studio Code でフォルダーを開きます。
4. 必要に応じて、リポジトリ内の C# コード プロジェクトをサポートするために追加のファイルがインストールされるまで待ちます

    > **注**: ビルドとデバッグに必要なアセットを追加するように求めるプロンプトが表示された場合は、**[今はしない]** を選択します。

5. `Labfiles/03-monitor-ai-services` フォルダーを展開します。

C# と Python の両方のコードが用意されています。 目的の言語のフォルダーを展開します。

## Azure AI サービス リソースをプロビジョニングする

サブスクリプションに **Azure AI サービス** リソースがまだない場合は、プロビジョニングする必要があります。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. 上部の検索バーで 「*Azure AI サービス*」を検索し、**[Azure AI サービス]** を選択し、次の設定で Azure AI サービス マルチサービス アカウント リソースを作成します。
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **[リージョン]**: 使用できるリージョンを選択します**
    - **[名前]**: *一意の名前を入力します*
    - **価格レベル**: Standard S0
3. 必要なチェックボックスを選択して、リソースを作成します。
4. デプロイが完了するまで待ち、デプロイの詳細を表示します。
5. リソースがデプロイされたら、そこに移動して、その**キーとエンドポイント** ページを表示します。 エンドポイント URI をメモします。後で必要になります。

## アラートを構成する

Azure AI サービス リソースのアクティビティを検出できるように、アラート ルールを定義して監視を開始します。

1. Azure portal で、Azure AI サービス リソースに移動し、[**アラート**] ページを ([**監視**] セクションで) 表示します。
2. **[+ 作成]** ドロップダウンを選択し、 **[警告ルール]** を選択します
3. [**アラート ルールの作成**] ページの [**スコープ**] で、Azure AI サービス リソースが表示されていることを確認します。 ( **[シグナルの選択]** ペインが開いている場合は閉じます)
4. **[条件]** タブを選択し、**[すべてのシグナルを表示]** リンクを選択して、右側に表示される **[シグナルの選択]** ペインを確認します。ここで、監視するシグナルの種類を選択できます。
5. **[シグナルの種類]** 一覧で、**[アクティビティ ログ]** セクションまで下にスクロールして、**[キーの一覧表示 (Cognitive Services API アカウント)]** を選択します。 **適用**を選択します。
6. 過去 6 時間のアクティビティを確認します。
7. **[アクション]** タブを選択します。*アクション グループ* を指定できることにご注意ください。 これにより、アラートが発生したときの自動アクションを構成できます。たとえば、電子メール通知を送信します。 この演習ではそれを行いません。ただし、実稼働環境でこれを行うと便利な場合があります。
8. **[詳細]** タブで、 **[アラート ルール名]** を **[キー一覧アラート]** に設定します。
9. **[確認および作成]** を選択します。 
10. アラートの構成を確認します。 **[作成]** を選択し、アラートルールが作成されるのを待ちます。
11. これで、次のコマンドを使用して、Azure AI サービス キーのリストを取得できます。*&lt;resourceName&gt;* を Azure AI サービス リソースの名前に置き換え、*&lt;resourceGroup&gt;* を作成したリソース グループの名前に置き換えます。

    ```
    az cognitiveservices account keys list --name <resourceName> --resource-group <resourceGroup>
    ```

    このコマンドは、Azure AI サービス リソースのキーのリストを返します。

    > **注**: Azure CLI にログインしていない場合、list keys コマンドを機能させるには、事前に `az login` を実行しておくことが必要な場合があります。

12. Azure portal を含むブラウザーに戻り、**警告ページ**を更新します。 表に **重要度4 - 詳細** 警告が表示されているはずです (表示されていない場合は、最大 5 分待ってから再度更新してください)。
13. アラートを選択して詳細を確認します。

## メトリックの視覚化

アラートを定義するだけでなく、Azure AI サービス リソースのメトリックを表示して、その使用率を監視できます。

1. Azure portal の Azure AI サービス リソースのページで、[**メトリック**] を ([**監視**] セクションで) を選択します。
2. 既存のグラフがない場合は、 **[+ 新しいグラフ]** を選択します。 次に、 **[メトリック]** リストで、視覚化できる可能な指標を確認し、 **[Total Calls]** を選択します。
3. **[集計]** リストで **[カウント]** を選択します。  これにより、Azure AI サービス リソースへの合計呼び出し数を監視できるようになります。これは、一定期間にサービスがどれだけ使用されているかを判断するのに役立ちます。
4. Azure AI サービスへの要求を生成するには、**curl** (HTTP 要求用のコマンド ライン ツール) を使用します。 ご利用のエディターで、**rest-test.cmd** を開き、そこに含まれる **curl** コマンド (以下に表示) を編集し、*&lt;yourEndpoint&gt;* と *&lt;yourKey&gt;* をお使いのエンドポイント URI と **Key1** キーに置き換えて、Azure AI サービス リソースで Text Analytics API を使用します。

    ```
    curl -X POST "<your-endpoint>/language/:analyze-text?api-version=2023-04-01" -H "Content-Type: application/json" -H "Ocp-Apim-Subscription-Key: <your-key>" --data-ascii "{'analysisInput':{'documents':[{'id':1,'text':'hello'}]}, 'kind': 'LanguageDetection'}"
    ```

5. 変更を保存して、次のコマンドを実行します。

    ```
    ./rest-test.cmd
    ```

    このコマンドは、入力データで検出された言語に関する情報を含む JSON ドキュメントを返します (これは英語でなければなりません)。

6. **rest-test** コマンドを複数回再実行して、呼び出しアクティビティを生成します ( **^** キーを使用して前のコマンドを切り替えることができます)。
7. Azure portal の **[メトリック]** ページに戻り、**合計呼び出し数**のグラフを更新します。 *curl* を使用して行った呼び出しがグラフに反映されるまで、数分かかる場合があります。更新されて含まれるまで、グラフを更新し続けます。

## リソースをクリーンアップする

このラボで作成した Azure リソースを他のトレーニング モジュールに使用していない場合は、それらを削除して、追加料金が発生しないようにすることができます。

1. `https://portal.azure.com` で Azure portal を開き、上部の検索バーで、このラボで作成したリソースを検索します。

2. [リソース] ページで **[削除]** を選択し、指示に従ってリソースを削除します。 または、リソース グループ全体を削除して、すべてのリソースを同時にクリーンアップすることもできます。

## 詳細情報

Azure AI サービスを監視するためのオプションの 1 つは、*診断ログ*を使用することです。 有効にすると、診断ログは Azure AI サービスのリソース使用状況に関する豊富な情報をキャプチャし、便利な監視およびデバッグ ツールになります。 診断ログを設定して情報を生成するまでに 1 時間以上かかる場合があるため、この演習では取り上げていませんが、「[Azure AI サービスのドキュメント](https://docs.microsoft.com/azure/ai-services/diagnostic-logging)」で詳細をご覧いただけます。